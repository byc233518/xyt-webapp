<!DOCTYPE html>
<html>
<head>
	<title>信活-登录</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="http://unpkg.com/iview/dist/styles/iview.css">
	<script type="text/javascript" src="https://cdn.bootcss.com/vue/2.5.16/vue.min.js"></script>
	<script type="text/javascript" src="http://unpkg.com/iview/dist/iview.min.js"></script>
	<script src="https://cdn.bootcss.com/axios/0.18.0/axios.min.js"></script>
	<style>
		.mt-20 {
			margin-top: 20px;
		}
		.tc {
			text-align: center;
		}
	</style>
</head>
<body>

<div id="app">
	<Row>
		<i-col :xs="{ span: 20, offset: 2 }" :lg="{ span: 12, offset: 6 }">
			<div style="marginTop: 100px; padding: 30px 100px 10px; ">
				<card style="width:100%">
					<i-form ref="formInline" :rules="ruleInline" :model="formInline" class="mt-20">
						<form-item prop="user" label="手机号">
							<i-input type="text" v-model="formInline.user" placeholder="手机号">
								<Icon type="ios-person-outline" slot="prepend"></Icon>
							</i-input>
						</form-item>
						<form-item prop="password" label="密码">
							<i-input type="password" v-model="formInline.password" placeholder="密码">
								<Icon type="ios-locked-outline" slot="prepend"></Icon>
							</i-input>
						</form-item>
						<form-item>
							<div class="tc">
								<i-button type="primary" size="large" @click="login">登录</i-button>
							</div>
						</form-item>
						<div style="text-align: right;">
							<a javascript="::;" @click="showForgetPasswordModal">忘记密码</a> |
							<a javascript="::;" @click="showSignupModal">注册账号</a>
						</div>
					</i-form>
				</card>
			</div>
		</i-col>
		<i-col span="6">&nbsp;</i-col>
		<Modal v-model="ForgetPasswordModalVisible" title="提示">
			请联系: <a href="tel: 15902019220">15902019220</a>
		</Modal>
		<Modal v-model="showSignupModalVisible" title="注册新账号">
			<i-form ref="signupForm" :rules="signupFormRule" :model="signupForm" class="mt-20" :label-width="80">
				<form-item prop="user" label="手机号">
					<i-input type="text" v-model="signupForm.user">
					</i-input>
				</form-item>
				<form-item label="密码" prop="passwd">
					<i-input type="password" v-model="signupForm.passwd"></i-input>
				</form-item>
				<form-item label="重复密码" prop="passwdCheck">
					<i-input type="password" v-model="signupForm.passwdCheck"></i-input>
				</form-item>
			</i-form>
			<div slot="footer">
				<div class="tc">
					<i-button type="primary" size="large" @click="signUp">注册</i-button>
				</div>
			</div>
		</Modal>
	</Row>

</div>

<script>
	new Vue({
		el: '#app',
		data() {
			const validatePass = (rule, value, callback) => {
				if (value === '') {
					callback(new Error('请输入密码'));
				} else {
					if (this.signupForm.passwdCheck !== '') {
						// 对第二个密码框单独验证
						this.$refs.signupForm.validateField('passwdCheck');
					}
					callback();
				}
			};
			const validatePassCheck = (rule, value, callback) => {
				if (value === '') {
					callback(new Error('请再次输入密码'));
				} else if (value !== this.signupForm.passwd) {
					callback(new Error('两次输入不一致,请重新输入!'));
				} else {
					callback();
				}
			};
			return {
				ForgetPasswordModalVisible: false,
				showSignupModalVisible: false,
				formInline: {
					user: '',
					password: ''
				},
				ruleInline: {
					user: [
						{required: true, message: '请输入手机号码', trigger: 'blur'}
					],
					password: [
//						{required: true, message: '请输入密码', trigger: 'blur'},
//						{type: 'string', min: 6, message: '密码不能少于6位', trigger: 'blur'}
					]
				},
				signupForm: {
					user: '',
					passwd: '',
					passwdCheck: '',
				},
				signupFormRule: {
					user: [
						{required: true, message: '请输入手机号码', trigger: 'blur'}
					],
					passwd: [
						{required: true, message: '请输入密码', trigger: 'blur'},
						{validator: validatePass, trigger: 'blur' }
					],
					passwdCheck: [
						{required: true, message: '请输入密码', trigger: 'blur'},
						{validator: validatePassCheck, trigger: 'blur' }
					],
				}
			}
		},
		methods: {
			showForgetPasswordModal() {
				this.ForgetPasswordModalVisible = true
			},
			showSignupModal() {
				this.showSignupModalVisible = true
				this.$refs['signupForm'].resetFields()
			},
			login() {
				this.$refs['formInline'].validate((valid) => {
					if (valid) {
						axios.post(`http://39.108.77.185:8081/xinhuo/member/login?utel=${this.formInline.user}&password=${this.formInline.password}&uType=${1}`).then((res) => {
							console.log(res)
							if(res.status === 200 && res.data.__statusCode === '1' ) {
								delete res.data.data.password
								localStorage.setItem('userinfo', JSON.stringify(res.data.data))
								this.$Message.success('登录成功!')
								setTimeout(() => {
									window.location.href = `${location.origin}/searchresume`
								}, 1000)
							} else {
								this.$Message.error(res.data.__errorMessage)
							}
						})
					} else {
//						this.$Message.error('Fail!');
					}
				})
			},
			signUp() {
				this.$refs['signupForm'].validate((valid) => {
					if (valid) {
						axios.post('http://39.108.77.185:8081/xinhuo/member/insert', {
							utel: this.signupForm.user,
							password: this.signupForm.passwdCheck,
							utype: 1,
						}).then((res) => {
							console.log(res)
							if(res.status === 200 && res.data.__statusCode === '1' ) {
								this.$Message.success('注册成功,3秒后自动跳转!')
								setTimeout(() => {
									axios.post('http://39.108.77.185:8081/xinhuo/member/login?utel='+ this.signupForm.user + '&password=' + this.signupForm.passwdCheck + '&uType=' + 1).then((res) => {
										if(res.status === 200 && res.data.__statusCode === '1' ) {
											delete res.data.data.password
											localStorage.setItem('userinfo', JSON.stringify(res.data.data))
											console.log(JSON.parse(localStorage.getItem('userinfo')))
											setTimeout(() => {
												window.location.href = `${location.origin}/searchresume`
											}, 1000)
										} else {
											this.$Message.error(res.data.__errorMessage)
										}
									})
								}, 3000)
							}
						})
					} else {

					}
				})
			},
			fullScreen() {
				document.documentElement.webkitRequestFullScreen()
			},
		},
		created() {
		},
	})
</script>
</body>
</html>